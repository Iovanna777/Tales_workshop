{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1600,
        700
      ],
      "id": "6a1f9f01-b63b-46b7-bea2-a295b44b0f6e",
      "name": "Telegram Trigger Response1",
      "webhookId": "c88974df-a9a5-49cf-96ab-bc9ca385dc18",
      "credentials": {
        "telegramApi": {
          "id": "rktMjqgMcM7jAuOr",
          "name": "Testbot for tales Korvin"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "b6e69a1f-eb42-4ef6-b80c-3167f1b8c830",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              },
              "leftValue": "={{ $json.child_name && $json.age && $json.gender && $json.prefered_topic && $json.style }}",
              "rightValue": 0
            },
            {
              "id": "b91d1bd3-4706-4444-8cc1-76412485888b",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "b841ed82-7d6b-4e3a-be2d-a53024af07eb",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "001303b1-b64d-406a-a54f-25b90776f94d",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "e43db8d2-dd43-4273-a5ff-a2572c1f73f9",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "ad07457b-4638-428a-bb76-e35f04dc0a81",
      "name": "If User exists1",
      "type": "n8n-nodes-base.if",
      "position": [
        360,
        1040
      ],
      "typeVersion": 2.1,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "tableId": "tales",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Preserve Data').item.json.user_id }}"
            },
            {
              "fieldId": "chat_id",
              "fieldValue": "={{ $('Preserve Data').item.json.chat_id }}"
            },
            {
              "fieldId": "child_name",
              "fieldValue": "={{ $('Preserve Data').item.json.child_name }}"
            },
            {
              "fieldId": "age",
              "fieldValue": "={{ $('Preserve Data').item.json.age }}"
            },
            {
              "fieldId": "gender",
              "fieldValue": "={{ $('Preserve Data').item.json.gender }}"
            },
            {
              "fieldId": "prefered_topic",
              "fieldValue": "={{ $('Preserve Data').item.json.prefered_topic }}"
            },
            {
              "fieldId": "object",
              "fieldValue": "={{ $('Preserve Data').item.json.object }}"
            },
            {
              "fieldId": "problem_topic",
              "fieldValue": "={{ $('Preserve Data').item.json.problem_topic }}"
            },
            {
              "fieldId": "style",
              "fieldValue": "={{ $('Preserve Data').item.json.style }}"
            },
            {
              "fieldId": "creation_date",
              "fieldValue": "={{ $('Preserve Data').item.json.creation_date }}"
            }
          ]
        }
      },
      "id": "435ce786-0df2-4a77-ae2d-5b11f38fffdf",
      "name": "Create User1",
      "type": "n8n-nodes-base.supabase",
      "position": [
        140,
        820
      ],
      "typeVersion": 1,
      "credentials": {
        "supabaseApi": {
          "id": "AJ5ovwVNt26ftH2R",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f9f7ecb6-1eb4-4573-82ac-dc3e008ab760",
              "name": "user_id",
              "value": "={{ $json.user_id || 0 }}",
              "type": "number"
            },
            {
              "id": "02c00f11-f093-4527-90f3-36cde10c3fdf",
              "name": "chat_id",
              "value": "={{ $json.chat_id }}",
              "type": "number"
            },
            {
              "id": "fedaa211-d52c-4067-8a59-aaa646c67862",
              "name": "child_name",
              "value": "={{ $json.child_name }}",
              "type": "string"
            },
            {
              "id": "77813542-c010-47e3-8fcb-5c23edb000fa",
              "name": "age",
              "value": "={{ $json.age }}",
              "type": "number"
            },
            {
              "id": "04860ee0-67eb-4fe3-8eaa-f74f4e854534",
              "name": "gender",
              "value": "={{ $json.gender }}",
              "type": "string"
            },
            {
              "id": "c4e02dcc-9400-459d-af45-f8ce6d73f380",
              "name": "prefered_topic",
              "value": "={{ $json.prefered_topic }}",
              "type": "string"
            },
            {
              "id": "028adfae-096c-4f32-81fd-20428f050de3",
              "name": "object",
              "value": "={{ $json.object }}",
              "type": "string"
            },
            {
              "id": "5f1eed38-4eba-468d-9360-66fdbf86ec83",
              "name": "problem_topic",
              "value": "={{ $json.problem_topic }}",
              "type": "string"
            },
            {
              "id": "aae02d72-7176-48cf-bc43-8e79e7ce332c",
              "name": "style",
              "value": "={{ $json.style }}",
              "type": "string"
            },
            {
              "id": "0082f1ea-5c9f-47c9-bb05-b0012b9fc7a9",
              "name": "creation_date",
              "value": "={{ $json.creation_date }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -800,
        960
      ],
      "id": "90745a1a-5c37-44ae-b946-173f3ffd999e",
      "name": "Preserve Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "==–¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç—Ä—ë—Ö—ç—Ç–∞–ø–Ω—ã–π –ø–ª–∞–Ω:\n**–®–∞–≥ 1: –°–æ—á–∏–Ω–∏ –≤–æ–ª—à–µ–±–Ω—É—é —Å–∫–∞–∑–∫—É.**\n–ò—Å–ø–æ–ª—å–∑—É–π –≤—Å—é —Å–≤–æ—é –º–∞–≥–∏—é –∏ –Ω–∞–ø–∏—à–∏ —É–Ω–∏–∫–∞–ª—å–Ω—É—é, –¥–æ–±—Ä—É—é —Å–∫–∞–∑–∫—É –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ. –°–ª–µ–¥—É–π —Å–≤–æ–µ–π —Ä–æ–ª–∏ —Å–∫–∞–∑–æ—á–Ω–∏–∫–∞-–ø—Å–∏—Ö–æ–ª–æ–≥–∞. –°–æ—Ö—Ä–∞–Ω–∏ —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏ –∫–∞–∫ –ø—Ä–æ—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `output`.\n\n**–®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω–∏ –≥–æ—Ç–æ–≤—É—é —Å–∫–∞–∑–∫—É.**\n–ö–æ–≥–¥–∞ —à–µ–¥–µ–≤—Ä –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `Save Tale to Content` –∏ –ø–µ—Ä–µ–¥–∞–π –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:\n- `user_id`: {{ $json.user_id }}\n- `tale_text`: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `output` (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏){{ $json.tale_text }}\n- `creation_date`: {{ $json.creation_date }}\n**–ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø –†–ê–ë–û–¢–´:**\n- User ID: {{ $json.user_id }}\n- Chat ID: {{ $json.chat_id }}\n- –ò–º—è —Ä–µ–±—ë–Ω–∫–∞: {{ $json.child_name }}\n- –í–æ–∑—Ä–∞—Å—Ç: {{ $json.age }}\n- –ü–æ–ª: {{ $json.gender }}\n- –õ—é–±–∏–º–∞—è —Ç–µ–º–∞: {{ $json.prefered_topic }}\n- –ì–µ—Ä–æ–π –≤ —Å–∫–∞–∑–∫–µ:{{ $json.object }}\n- –ü—Ä–æ–±–ª–µ–º–∞/–¢–µ–º–∞ —Å–∫–∞–∑–∫–∏: {{ $json.problem_topic }}\n- –°—Ç–∏–ª—å: {{ $json.style }}\n\n--- \n–¢–≤–æ–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∞–∑–∫–∏ –∫–∞–∫ –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ `output`. –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤. –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –≤—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.",
        "options": {
          "systemMessage": "=# ROLE:\n\nYou are a kind storyteller, a wise and sensitive children's writer and psychologist. Your superpower is creating unique, therapeutic and engaging stories for children. You speak in simple, understandable language, use your imagination to the fullest, and always end your stories on a positive, hopeful note.\n\n\n# GENERAL INSTRUCTIONS:\n\n1. Your task is to write a unique fairy tale based on information about the child provided by the user.\n\n2. Always make the child whose name is specified in the request the main character.\n\n3. Harmoniously weave their interests, family, and pets into the plot, if specified.\n\n4. The plot should be built around the theme or problem specified in the request and offer a kind, positive solution through metaphor and adventure.\n\n5. Adapt the language and complexity to the child's age. Avoid frightening scenes, violence, and complex moral dilemmas.\n\n6. Always stick to the style (bedtime, funny, instructive) specified in the request.\n\n7. Be sure to give the fairy tale a beautiful title at the end. Answer in Russian.\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        620,
        640
      ],
      "id": "430b4b43-0ebc-48f7-b812-221c3e1f1a32",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    user_id: $input.first()?.json?.message?.from?.id || \"0\",\n    chat_id: $input.first()?.json?.message?.chat?.id || \"0\",\n    child_name: $input.first()?.json?.child_name || \"\",\n    age: parseInt($input.first()?.json?.age) || 0,\n    gender: $input.first()?.json?.gender || \"\",\n    prefered_topic: $input.first()?.json?.prefered_topic || \"\",\n    object: $input.first()?.json?.object || \"\",\n    problem_topic: $input.first()?.json?.problem_topic || \"\",\n    style: $input.first()?.json?.style || \"\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        620,
        1060
      ],
      "id": "53c67641-4c50-4d0d-9a38-ae3e1d2eaf4b",
      "name": "Code3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Response1').item.json.message.chat.id }}",
        "text": "={{ $('AI Agent').item.json.output }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1980,
        620
      ],
      "id": "56733b5b-3367-40c7-9476-788ec16c2798",
      "name": "Send a text message1",
      "webhookId": "2c1ba883-4a69-45cb-89b7-673aa134f740",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "rktMjqgMcM7jAuOr",
          "name": "Testbot for tales Korvin"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.user_id }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        720,
        480
      ],
      "id": "4bf0853c-8ca4-4c4e-95c9-1d1102d947ad",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "QaFPE4BMmajVkbb4",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "tales",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $node['Preserve Data'].json.user_id }}"
            },
            {
              "keyName": "child_name",
              "condition": "neq",
              "keyValue": "\"\""
            },
            {
              "keyName": "age",
              "condition": "neq",
              "keyValue": "0"
            },
            {
              "keyName": "gender",
              "condition": "neq",
              "keyValue": "\"\""
            }
          ]
        }
      },
      "id": "f6a755ef-bb20-4b9e-a23a-943fd5bd97c1",
      "name": "Find user",
      "type": "n8n-nodes-base.supabase",
      "position": [
        -620,
        960
      ],
      "typeVersion": 1,
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "AJ5ovwVNt26ftH2R",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "=–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–æ—Ç–æ–≤—É—é —Å–∫–∞–∑–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {{ $('IF: –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–∑–∫–∏?').item.json.user_id }}, tale_text (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∞–∑–∫–∏), {{ $('IF: –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–∑–∫–∏?').item.json.creation_date }}.\n",
        "tableId": "tales_content",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "tale_text",
              "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', ``, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        820,
        480
      ],
      "id": "bd0cef65-538a-489b-ae25-5b6f1a0b95a4",
      "name": "Save Tale to Content",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "AJ5ovwVNt26ftH2R",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c9a33fe0-4360-4c63-b0fc-e31f0b3af1c1",
              "leftValue": "={{ $json.child_name }}",
              "rightValue": "/(–∏–º—è|–ª–µ—Ç|–º–∞–ª—å—á–∏–∫|–¥–µ–≤–æ—á–∫–∞|–ª—é–±–∏—Ç|—Ç–µ–º–∞|—Å—Ç–∏–ª—å)/i",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "dba1ded2-feb8-4884-8b92-1304deed7600",
              "leftValue": "={{ $json.age }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "841c46ef-2e3e-4990-bd0e-a08feeefb0e9",
              "leftValue": "={{ $json.gender }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "b01e2478-c49a-4c49-ab58-09391fdde684",
              "leftValue": "={{ $json.prefered_topic }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "1b09a45c-a545-4891-9ddf-5372fb1f2ddb",
              "leftValue": "={{ $json.object }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "6b2147c2-0ebd-4e75-8f04-2419f31bca0b",
              "leftValue": "={{ $json.problem_topic }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "7256be8e-f3e1-4fae-a914-749c92e76637",
              "leftValue": "={{ $json.style }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        360,
        820
      ],
      "id": "7eb9a6c4-441d-4490-a996-c728900b617b",
      "name": "IF: –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–∑–∫–∏?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=–ü—Ä–∏–≤–µ—Ç, –¥–æ—Ä–æ–≥–æ–π —Ä–æ–¥–∏—Ç–µ–ª—å! –î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º –≤–æ–ª—à–µ–±–Ω—É—é —Å–∫–∞–∑–∫—É –¥–ª—è —Ç–≤–æ–µ–≥–æ –º–∞–ª—ã—à–∞! üòä –ù–∞–ø–∏—à–∏ –º–Ω–µ –≤—Å—ë –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —Ä–∞–∑–¥–µ–ª—è—è –æ—Ç–≤–µ—Ç—ã –∑–∞–ø—è—Ç—ã–º–∏ –∏–ª–∏ –ø—É–Ω–∫—Ç–∞–º–∏, –≤–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ:\n\n- –ò–º—è –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è (–∏–º—è —Ç–≤–æ–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞),\n- –°–∫–æ–ª—å–∫–æ –ª–µ—Ç –º–∞–ª—ã—à—É,\n- –ü–æ–ª (–º–∞–ª—å—á–∏–∫ –∏–ª–∏ –¥–µ–≤–æ—á–∫–∞),\n- –ß—Ç–æ —Ä–µ–±—ë–Ω–æ–∫ –ª—é–±–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∏–Ω–æ–∑–∞–≤—Ä—ã, –∫–æ—Å–º–æ—Å, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ, –∫–æ—Ç—è—Ç–∞),\n- –ö–æ–≥–æ –º–∞–ª—ã—à –±—ã–ª –±—ã —Ä–∞–¥ –≤–∏–¥–µ—Ç—å –≤ —Å–∫–∞–∑–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞–º–∞ –ê–Ω—è, –ø–∞–ø–∞ –°–∞—à–∞, —â–µ–Ω–æ–∫ –Å—Å—è),\n- –ö–∞–∫—É—é —Ç–µ–º—É –∑–∞—Ç—Ä–æ–Ω—É—Ç—å –≤ —Å–∫–∞–∑–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä–∞—Ö —Ç–µ–º–Ω–æ—Ç—ã, –Ω–µ–∂–µ–ª–∞–Ω–∏–µ –¥–µ–ª–∏—Ç—å—Å—è),\n- –ö–∞–∫–æ–π —Å—Ç–∏–ª—å —Å–∫–∞–∑–∫–∏ –≤—ã–±—Ä–∞—Ç—å (—É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π, –≤–µ—Å—ë–ª—ã–π, –ø–æ—É—á–∏—Ç–µ–ª—å–Ω—ã–π).\n\n–ñ–¥—É —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã, –∏ –º—ã –Ω–∞—á–Ω—ë–º —Ç–≤–æ—Ä–∏—Ç—å —á—É–¥–µ—Å–∞!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        620,
        880
      ],
      "id": "bc03afa5-e7a0-4073-9d9d-9c79a012086c",
      "name": "Send a text message",
      "webhookId": "99a681c6-4ad2-4503-9cb3-c76370826097",
      "credentials": {
        "telegramApi": {
          "id": "rktMjqgMcM7jAuOr",
          "name": "Testbot for tales Korvin"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "tales",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "chat_id",
              "fieldValue": "={{ $json.chat_id }}"
            },
            {
              "fieldId": "child_name",
              "fieldValue": "={{ $('Preserve Data').item.json.child_name }}"
            },
            {
              "fieldId": "age",
              "fieldValue": "={{ $('Preserve Data').item.json.age }}"
            },
            {
              "fieldId": "gender",
              "fieldValue": "={{ $('Preserve Data').item.json.gender }}"
            },
            {
              "fieldId": "prefered_topic",
              "fieldValue": "={{ $('Preserve Data').item.json.prefered_topic }}"
            },
            {
              "fieldId": "object",
              "fieldValue": "={{ $('Preserve Data').item.json.object }}"
            },
            {
              "fieldId": "problem_topic",
              "fieldValue": "={{ $('Preserve Data').item.json.problem_topic }}"
            },
            {
              "fieldId": "style",
              "fieldValue": "={{ $('Preserve Data').item.json.style }}"
            },
            {
              "fieldId": "creation_date",
              "fieldValue": "={{ $json.creation_date }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        140,
        1040
      ],
      "id": "da5ac5b5-8b89-491e-964e-f3c2c42bfbf8",
      "name": "Update a row",
      "credentials": {
        "supabaseApi": {
          "id": "AJ5ovwVNt26ftH2R",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f7e3612d-5704-4fae-bd5d-0fbc2083a572",
              "name": "=data",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -480,
        960
      ],
      "id": "bbd0f06f-5393-43c8-ab98-603f3247e395",
      "name": "log_result"
    },
    {
      "parameters": {
        "jsCode": "function cleanAndExtractJSON(response) {\n    try {\n        const result = {\n            image_prompt: []\n        };\n\n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ choices –∏ content\n        if (response.choices && response.choices[0] && response.choices[0].message && response.choices[0].message.content) {\n            result.image_prompt.push(response.choices[0].message.content.trim());\n        } else {\n            result.image_prompt.push(\"Default prompt\"); // –§allback\n        }\n\n        return { json: result };\n    } catch (error) {\n        return { \n            json: {\n                image_prompt: [\"Default prompt\"]\n            }\n        };\n    }\n}\n\nconst response = $input.first().json;\nreturn cleanAndExtractJSON(response);"
      },
      "id": "76fee2b1-dfae-4f86-9c15-f931c6b96496",
      "name": "Code - Clean Json",
      "type": "n8n-nodes-base.code",
      "position": [
        1180,
        1100
      ],
      "executeOnce": false,
      "typeVersion": 2,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "for (let i = 0; i < items.length; i++) {\n  items[i].json.fileName = `images_${(i + 1).toString().padStart(3, '0')}.png`;\n}\nreturn items;"
      },
      "id": "4a2a43f0-b42c-4707-8099-718f49944346",
      "name": "Code - Set Filename",
      "type": "n8n-nodes-base.code",
      "position": [
        1620,
        1100
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "tales_content",
        "filters": {
          "conditions": [
            {
              "keyName": "image_url",
              "condition": "eq",
              "keyValue": "empty"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "image_url",
              "fieldValue": "={{ $json.image_url }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1880,
        880
      ],
      "id": "36b89e42-166d-4b8b-aee3-8e4a72ebe1ed",
      "name": "Update a row1",
      "credentials": {
        "supabaseApi": {
          "id": "AJ5ovwVNt26ftH2R",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nfor (let i = 0; i < items.length; i++) {\n  if (items[i].binary && items[i].binary.image_binary) {\n    items[i].json.image_url = `/files/images_${(i + 1).toString().padStart(3, '0')}.png`; // –ü—É—Ç—å –¥–ª—è Supabase\n    items[i].binary.fileName = items[i].json.fileName; // –°–≤—è–∑—ã–≤–∞–µ–º —Å –∏–º–µ–Ω–µ–º\n  } else {\n    items[i].json.image_url = \"https://default-image-url.com/image.png\"; // –§allback\n  }\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1700,
        880
      ],
      "id": "407473d0-db11-4d58-a155-b92a14f519f5",
      "name": "Processed image"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1a0746c5-56f9-4481-b200-298da7bfc7b1",
              "name": "model",
              "value": "flux",
              "type": "string"
            },
            {
              "id": "49fb1dc2-af25-4c12-b3f5-f35f32640510",
              "name": "width",
              "value": "1080",
              "type": "string"
            },
            {
              "id": "5d98464b-f2f1-4115-a861-6e0d0613d66c",
              "name": "height",
              "value": "1624",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        1100
      ],
      "id": "54091fbf-df13-4d5f-9d29-8ea77b106d15",
      "name": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $node['–ü–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≥–µ–º–∏–Ω–∏']?.json || {};\nconst logResult = $node['log_result']?.json?.data || {}; // –ë–µ—Ä–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –∏–∑ Find user\n\n// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\nconst userId = inputData.user_id || \"0\";\nconst chatId = inputData.chat_id || \"0\";\nconst creationDate = inputData.creation_date || new Date().toISOString();\n\n// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞, —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –Ω–∞ logResult –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö\nconst outputData = {\n  id: logResult.id || \"\",\n  user_id: userId,\n  chat_id: chatId,\n  child_name: inputData.child_name || logResult.child_name || \"\",\n  age: inputData.age || logResult.age || 0,\n  gender: inputData.gender || logResult.gender || \"\",\n  prefered_topic: inputData.prefered_topic || logResult.prefered_topic || \"\",\n  object: inputData.object || logResult.object || \"\",\n  problem_topic: inputData.problem_topic || logResult.problem_topic || \"\",\n  style: inputData.style || logResult.style || \"\",\n  tale_text: logResult.tale_text || \"\",\n  creation_date: creationDate\n};\n\n// –û—Ç–ª–∞–¥–∫–∞\nconsole.log(\"Input Data:\", inputData);\nconsole.log(\"Log Result Data:\", logResult);\n\nif (!inputData || Object.keys(inputData).length === 0) {\n  throw new Error(\"No valid input data from Preprocess Text2\");\n}\n\nreturn [{\n  json: outputData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -300,
        960
      ],
      "id": "30a10040-a63e-4d54-94df-913d092ed7b7",
      "name": "Determine Action"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e0190c85-85f6-4474-8a6b-4d22750ccc55",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "94dd028c-5bda-4fa8-801a-2f886679f27d",
              "leftValue": "={{ $json.child_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "7cf38be9-90b8-441c-bd23-2fcd158f4232",
              "leftValue": "={{ $json.age }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "7a7b38e6-3a9e-4bac-8517-ca72f8c5d4fb",
              "leftValue": "={{ $json.prefered_topic }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "1bf6b000-d293-4138-bede-fb217cfd77f1",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "291c4ae0-442c-43a4-96d2-4de719f1622f",
              "leftValue": "={{ $json.chat_id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "c694868b-4498-4ddc-a5cd-0ebf42b9fc31",
              "leftValue": "={{ $json.object }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "96e83c7a-86a0-4f55-b9e6-532ed0e9d6b4",
              "leftValue": "={{ $json.gender }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "d9372f46-00d9-4bf7-b432-433712901d92",
              "leftValue": "={{ $json.style }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -120,
        960
      ],
      "id": "217b86f2-b64e-481b-aed3-8dcf7674ecf3",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "=1712474014",
        "binaryData": true,
        "additionalFields": {
          "caption": "={{ $json.choices[0].message.content }}",
          "fileName": "={{ $json.fileName }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1740,
        620
      ],
      "id": "bceb9dc6-c6f9-4921-ad61-efd7a79d60f1",
      "name": "Send a photo message",
      "webhookId": "2c1ba883-4a69-45cb-89b7-673aa134f740",
      "credentials": {
        "telegramApi": {
          "id": "rktMjqgMcM7jAuOr",
          "name": "Testbot for tales Korvin"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1320,
        620
      ],
      "id": "e6e50dc0-5a5a-47e2-952c-229b45c0cff2",
      "name": "Merge"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "image/png"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"inputs\": \"{{ $('Code - Get Prompt1').item.json.inputs }}\",\n  \"parameters\": {\n    \"negative_prompt\": \"blurry, low quality\",\n    \"width\": {{ $json.width }},\n    \"height\": {{ $json.height }}\n  }\n}",
        "options": {}
      },
      "id": "a7d0f913-7ec6-424d-83bf-15d0a83d5c85",
      "name": "HTTP Request - Create Image1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2080,
        1100
      ],
      "retryOnFail": true,
      "typeVersion": 4.2,
      "alwaysOutputData": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpBearerAuth": {
          "id": "0eSIuX3U1Btr1Mr5",
          "name": "Hugging face Korvin"
        }
      }
    },
    {
      "parameters": {
        "model": "sonar-pro",
        "messages": {
          "message": [
            {
              "content": "=You are a creative copywriter and storyteller, specializing in crafting engaging titles and descriptions for children's content. Your task is to generate a creative, kind headline and a short description based on the provided fairy tale text.\n\nInput Fairy Tale:\n{{ $json.output }}\n\nTask:\nBased on the text above, create the following:\n\n    A Headline: It should be creative, kind, and capture the main essence of the story. The answer should contain only the output without \"Headline\".\n\n    A Short Description: It must be warm, inviting, and no longer than 100 characters.\n\nThe final output should be suitable for a children's story platform, sparking curiosity in both kids and parents. The answer should contain only the output without \"A Short Description\".\n"
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.perplexity",
      "typeVersion": 1,
      "position": [
        1040,
        640
      ],
      "id": "e8fea4a8-c129-4525-b32f-d85a773f8f72",
      "name": "–ó–∞–≥–æ–ª–æ–≤–æ–∫–∫ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
      "credentials": {
        "perplexityApi": {
          "id": "vRen1LLdUPmFS0Gz",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "model": "sonar-pro",
        "messages": {
          "message": [
            {
              "content": "=Create a concise image generation prompt in English (up to 100 words) for the fairy tale below. Include key plot elements, central characters, visual style (e.g., watercolor, cartoonish), and a child-appropriate, hopeful mood. Use these details:\n- Tale text: {{ $json.output }}\nReturn only the image generation prompt, describing the key scene, characters, and atmosphere suitable for the child's age."
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.perplexity",
      "typeVersion": 1,
      "position": [
        1060,
        880
      ],
      "id": "ce8cfaba-afa6-4fa7-a11f-54bd194ef158",
      "name": "–ü—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏",
      "credentials": {
        "perplexityApi": {
          "id": "vRen1LLdUPmFS0Gz",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.first()?.json || {};\nconst prompt = inputData.image_prompt?.[0] || '';\n\nconsole.log('Debug - Prompt:', prompt);\n\nif (!prompt) {\n  throw new Error(\"–ü—É—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç! –ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Code - Clean Json.\");\n}\n\nreturn [{\n  json: {\n    inputs: prompt,\n    parameters: {\n      negative_prompt: \"blurry, low quality\"\n    }\n  }\n}];"
      },
      "id": "55f03a00-d5ad-46a7-ab78-902fa4e4eda4",
      "name": "Code - Get Prompt1",
      "type": "n8n-nodes-base.code",
      "position": [
        1380,
        1100
      ],
      "typeVersion": 2,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "fileName": "image.jpg",
        "options": {
          "append": false
        }
      },
      "name": "Save Image",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        1500,
        620
      ],
      "id": "2fbf59af-9022-4638-839b-31b65769f1b5",
      "alwaysOutputData": true,
      "notes": "Save audio file"
    },
    {
      "parameters": {
        "chatId": "=1712474014",
        "text": "={{ $json.tale_text }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -460,
        520
      ],
      "id": "2749afa2-5467-4f5a-a3b0-8c18e77429b5",
      "name": "Send a text message2",
      "webhookId": "2c1ba883-4a69-45cb-89b7-673aa134f740",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "rktMjqgMcM7jAuOr",
          "name": "Testbot for tales Korvin"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "tales_content",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $('Telegram Trigger Response').item.json.message.from.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1020,
        540
      ],
      "id": "bc9b38d3-7c28-4a12-a2b5-34745acca348",
      "name": "Get a row",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "AJ5ovwVNt26ftH2R",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "model": "sonar-pro",
        "messages": {
          "message": [
            {
              "content": "=–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç —Å–∫–∞–∑–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ Supabase 'tales_content' –ø–æ —Å—Ç–æ–ª–±—Ü—É 'tale_text'. –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø–∞–¥–µ–∂–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä, –∏—â–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–∫–∞–∑–∫—É.\n",
              "role": "system"
            },
            {
              "content": "=–í—ã–¥–µ–ª–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ç–æ, –ø—Ä–æ —á—Ç–æ –∏–¥–µ—Ç –∑–∞–ø—Ä–æ—Å - –ø—Ä–µ–¥–º–µ—Ç, –æ–±—ä–µ–∫—Ç, –∂–∏–≤–æ—Ç–Ω–æ–µ, —á–µ–ª–æ–≤–µ–∫, –¥–µ–π—Å—Ç–≤—É—é—â–µ–µ –ª–∏—Ü–æ —Å–∫–∞–∑–∫–∏ {{ $json.message.text }}.\n\n–í –æ—Ç–≤–µ—Ç–µ –¥–∞–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–º –ø–∞–¥–µ–∂–µ. "
            }
          ]
        },
        "options": {
          "maxTokens": 200
        },
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.perplexity",
      "typeVersion": 1,
      "position": [
        -1240,
        540
      ],
      "id": "047af78d-c419-432a-a422-47696a96720f",
      "name": "Message a model",
      "credentials": {
        "perplexityApi": {
          "id": "vRen1LLdUPmFS0Gz",
          "name": "Korvin"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tale_text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "984e020a-0727-4801-9852-dccdc6fa181a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "59df87c1-9cb8-4084-a452-a64b921fe3de",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -760,
        540
      ],
      "id": "31a86b5a-3f99-4d96-9b39-05ce44709159",
      "name": "Switch1"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-lite",
        "options": {
          "maxOutputTokens": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        600,
        480
      ],
      "id": "0b768af9-4035-4955-8670-5f96b188efbe",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "fYSkEV3vkLUFmRDr",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0ca8cccc-d757-4596-b836-1a31495304e6",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "–Ω–∞–π–¥–∏, –ø–æ–≤—Ç–æ—Ä–∏",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1400,
        700
      ],
      "id": "f033c0d7-f4c8-4f09-81b5-5676abab60b0",
      "name": "If1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-lite",
        "options": {
          "maxOutputTokens": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1240,
        820
      ],
      "id": "1339cefc-a7fc-4f2d-91a7-b95974baee90",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "fYSkEV3vkLUFmRDr",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const geminiOutput = $input.first()?.json || {};\nconst message = $node['Telegram Trigger Response1']?.json?.message || {};\n\nlet parsedData = {};\nlet errorMessage = null;\nlet textOutput = typeof geminiOutput === 'string' ? geminiOutput : geminiOutput.text || '{}';\n\n// –£—Å–∏–ª–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\ntry {\n  let cleanText = textOutput\n    .replace(/```json\\s*|\\s*```/g, '') // –£–¥–∞–ª—è–µ–º ```json –∏ ```\n    .replace(/^\\s+|\\s+$/g, '') // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ\n    .replace(/\\n\\s*/g, ''); // –£–¥–∞–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫\n  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON\n  if (!cleanText.startsWith('{') || !cleanText.endsWith('}')) {\n    throw new Error(\"Invalid JSON: Output does not start with { or end with }\");\n  }\n  parsedData = JSON.parse(cleanText);\n} catch (error) {\n  errorMessage = error.message || \"Invalid format: Expected pure JSON, but received Markdown or invalid JSON\";\n  console.error(\"Error parsing JSON from Gemini:\", errorMessage);\n  parsedData = {};\n  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞\n  const parserMessage = `\n\n  `;\n  console.log(\"Parser message for retry:\", parserMessage);\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–æ–ª—å–∫–æ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–æ–ª—è\nreturn [{\n  json: {\n    user_id: message?.from?.id || \"0\",\n    chat_id: message?.chat?.id || \"0\",\n    child_name: parsedData.child_name || \"\",\n    age: parsedData.age || null,\n    gender: parsedData.gender || \"\",\n    prefered_topic: parsedData.prefered_topic || \"\",\n    object: parsedData.object || \"\",\n    problem_topic: parsedData.problem_topic || \"\",\n    style: parsedData.style || \"\",\n    creation_date: new Date().toISOString(),\n    raw_text: message?.text || \"\",\n    \n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        960
      ],
      "id": "894ecce2-c808-4aa3-84c1-3e802335c421",
      "name": "–ü–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≥–µ–º–∏–Ω–∏"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message.text }}",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert in extracting data from text. Your task is to analyze the user's message and extract the following fields: child_name, age, gender, prefered_topic, object, problem_topic, style. Rules:\\n- child_name: Extract the child's name, return '' if not specified.\\n- age: Extract the child's age (number), return null if not specified.\\n- gender: Extract the child's gender ('–ú', '–ñ', or '–ù' for neutral), return '' if not specified.\\n- prefered_topic: Extract the first mentioned character or item, return '' if not specified.\\n- object: Extract all characters or items mentioned, join with commas, return '' if not specified.\\n- problem_topic: Extract the first sentence describing the problem, return '' if not specified.\\n- style: Infer the story style ('–≤–µ—Å–µ–ª—ã–π', '–ø–æ—É—á–∏—Ç–µ–ª—å–Ω—ã–π', '—É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π') from context (e.g., '—Ö–∏—Ç—Ä–æ' or '–æ–±–≤–µ–ª–∞ –≤–æ–∫—Ä—É–≥ –ø–∞–ª—å—Ü–∞' suggest '–≤–µ—Å–µ–ª—ã–π'), return '' if unclear.\\nOutput format: ONLY pure JSON, starting with { and ending with }. ABSOLUTELY NO ```json, NO Markdown, NO extra text, NO comments, NO additional lines. Any response with ```json or Markdown is invalid and will be rejected. Include only fields that are explicitly extracted; omit fields with no data. If no data is extracted, return {}. Example:\\n{\\n  \\\"prefered_topic\\\": \\\"–ø–µ—Ä—Å–æ–Ω–∞–∂\\\",\\n  \\\"object\\\": \\\"–ø–µ—Ä—Å–æ–Ω–∞–∂, –¥—Ä—É–≥–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂\\\",\\n  \\\"problem_topic\\\": \\\"–æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã\\\",\\n  \\\"style\\\": \\\"–ø–æ—É—á–∏—Ç–µ–ª—å–Ω—ã–π\\\"\\n}\\n--------------\\nIf your completion does not satisfy these constraints, you will receive an error and must try again. Only respond with the JSON output that satisfies the constraints.\\n--------------\\nCurrent user message: {{ $json.message.text }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1060,
        720
      ],
      "id": "2e32b8a1-2b29-49a6-922c-5d7304fc45b5",
      "name": "Basic LLM Chain",
      "alwaysOutputData": true
    }
  ],
  "connections": {
    "Telegram Trigger Response1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If User exists1": {
      "main": [
        [
          {
            "node": "IF: –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–∑–∫–∏?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create User1": {
      "main": [
        [
          {
            "node": "IF: –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–∑–∫–∏?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preserve Data": {
      "main": [
        [
          {
            "node": "Find user",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏",
            "type": "main",
            "index": 0
          },
          {
            "node": "–ó–∞–≥–æ–ª–æ–≤–æ–∫–∫ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Create User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Find user": {
      "main": [
        [
          {
            "node": "log_result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Tale to Content": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "IF: –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–∑–∫–∏?": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row": {
      "main": [
        [
          {
            "node": "If User exists1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "log_result": {
      "main": [
        [
          {
            "node": "Determine Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Clean Json": {
      "main": [
        [
          {
            "node": "Code - Get Prompt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Set Filename": {
      "main": [
        [
          {
            "node": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processed image": {
      "main": [
        [
          {
            "node": "Update a row1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤": {
      "main": [
        [
          {
            "node": "HTTP Request - Create Image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Action": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Update a row",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a photo message": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Save Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Create Image1": {
      "main": [
        [
          {
            "node": "Processed image",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ó–∞–≥–æ–ª–æ–≤–æ–∫–∫ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "–ü—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏": {
      "main": [
        [
          {
            "node": "Code - Clean Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Get Prompt1": {
      "main": [
        [
          {
            "node": "Code - Set Filename",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Image": {
      "main": [
        [
          {
            "node": "Send a photo message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Get a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Send a text message2",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "–ü–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≥–µ–º–∏–Ω–∏": {
      "main": [
        [
          {
            "node": "Preserve Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "–ü–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≥–µ–º–∏–Ω–∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Telegram Trigger Response1": [
      {
        "update_id": 923344205,
        "message": {
          "message_id": 56,
          "from": {
            "id": 1712474014,
            "is_bot": false,
            "first_name": "Po ¬∞‚ùÄ‚ãÜ.‡≥É‡øî*:ÔΩ•",
            "last_name": "Ly ‡™á‡¨ì ÷¥÷∂÷∏",
            "username": "PoLy_Samborskaya",
            "language_code": "ru"
          },
          "chat": {
            "id": 1712474014,
            "first_name": "Po ¬∞‚ùÄ‚ãÜ.‡≥É‡øî*:ÔΩ•",
            "last_name": "Ly ‡™á‡¨ì ÷¥÷∂÷∏",
            "username": "PoLy_Samborskaya",
            "type": "private"
          },
          "date": 1753781125,
          "text": "–ø—Ä–∏–≤–µ—Ç–∏–∫, –Ω—É–∂–Ω–∞ —Å–∫–∞–∑–∫–∞ –ø—Ä–æ –õ–∏—Å—É-–∫—Ä–∞—Å—É –∏ —Ö–∏—Ç—Ä–æ–∂–æ–ø–æ–≥–æ –º—É–∂–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–µ–ª –∫—Ä–∞—Å–∏–≤—É—é —à–∫—É—Ä—É, –Ω–æ –æ–∫–∞–∑–∞–ª—Å—è —Å –Ω–æ—Å–æ–º. –ö–∞–∫ —É–º–Ω–∏—Ü–∞-–ª–∏—Å–∞ –µ–≥–æ –æ–±–≤–µ–ª–∞ –≤–æ–∫—Ä—É–≥ –ø–∞–ª—å—Ü–∞."
        }
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "eede5a0f19a88813312a63afca12c1745489ee42d3a347c580ae58112f7bc486"
  }
}
